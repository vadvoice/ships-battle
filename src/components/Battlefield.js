import { buildTableContent } from '@/libs/helpers';
import React, { useRef, useState, useEffect } from 'react';

export default function Battlefield({
  autoGenerated,
  gameState,
  position,
}) {
  const initialBattlefieldSetup = autoGenerated ? gameState.enemy : gameState.player;
  const battlefieldTable = useRef();
  const [battlefield, setBattlefield] = useState(initialBattlefieldSetup);

  useEffect(() => {
    if (!battlefield.fleet.length || autoGenerated) {
      return;
    }

    battlefield.fleet.map((el) => {
      el.position.map((ship) => {
        let cell = ship.ref;

        if (!cell) {
          cell = battlefieldTable.current.querySelector(
            `td[data-index="${ship.x}"][data-row="${ship.y}"]`
          );
        }
        if (!cell) {
          return;
        }
        cell.classList.add(ship.shipColor);
      });
    });
    if (autoGenerated) {
      return;
    }
  }, [battlefield.fleet, autoGenerated]);

  const handleBattlefieldClick = (e) => {
    if (e.target.tagName !== 'TD') {
      return;
    }

    const isCellContainsShip = battlefield.fleet.some((el) => {
      return el.position.some((ship) => {
        return ship.raw === e.target.dataset.index + e.target.dataset.row;
      });
    });
    if (isCellContainsShip) {
      e.target.classList.add(`after:content-['❌']`);
    } else {
      e.target.classList.add(`after:content-['⚫']`);
    }
  };

  return (
    <div>
      <h4 className="text-2xl font-bold dark:text-white text-center my-2">
        {autoGenerated ? 'PC' : 'Player'}
      </h4>

      <table
        ref={battlefieldTable}
        className={`m-0 border-spacing-0.5 border-separate`}
        onClick={handleBattlefieldClick}
      >
        {buildTableContent()}
      </table>
    </div>
  );
}
